<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Facturas</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/estilos.css">
</head>
<body class="p-4">

    <h2 class="text-center text-bg-danger">Ingreso de Facturas</h2>
<br>
<form action="/facturas/registrar" method="POST" >
    <div class="col-md-6">
      <input name="serie" placeholder="Serie" class="form-control w-25" required maxlength="5">
    </div>
    <div class="col-md-6">
      <input name="numero" placeholder="Nº de Factura" class="form-control w-25" required maxlength="10">
    </div>
    <div class="col-md-6">
      <select name="proveedor" class="form-select w-50" required>
      <option value="">-- Seleccione un Proveedor --</option>
      <% dvprov.forEach(rp => { %>
      <option value="<%= rp.seller %>"><%= rp.seller.toUpperCase() %></option>
      <% }) %>
      </select>
    </div>

    <div id="lineas-producto">
  <div class="row mb-2 linea-producto">
    <div class="col-md-4">
      <select name="producto[]" class="form-select" required>
        <option value="">-- Seleccione un producto --</option>
        <% productos.forEach(p => { %>
          <option value="<%= p.nombre %>"><%= p.nombre.toUpperCase()%> (<%= p.codigo %>)</option>
        <% }) %>
      </select>
    </div>
    <div class="col-md-2">
      <input name="cantidad[]" placeholder="Cant." class="form-control" required>
    </div>
    <div class="col-md-2">
      <input name="precio_unitario[]" placeholder="Precio" class="form-control" required>
    </div>
    <div class="col-md-2">
      <button type="button" class="btn btn-danger" onclick="eliminarLinea(this)">Eliminar</button>
    </div>
  </div>
</div>

      <button type="button" class="btn btn-secondary mb-2" onclick="agregarLinea()">+ Agregar otro producto</button><br>
      
        <div class="col-md-2"><br>
    <button type="submit" class="btn btn-success w-100">Registrar Factura</button>
  </div>
</form>

<br>
<h5>Ultimas 10 (diéz) Facturas Registradas</h5>
<table class="table table-bordered table-sm">
    <thead class="table-light">
      <tr>
        <th>ID</th><th>Fecha</th><th>Serie - Fact Nº</th><th>Proveedor</th><th>Producto</th><th>Cant.</th><th>Precio$</th><th>Usuario</th><th>Recepción</th><th>Estado</th>
      </tr>
    </thead>
    <tbody>
  <% facturas.forEach(f => { %>
    <tr>
      <td><%= f.id %></td>
      <td><%= f.fecha %></td>
      <td><%= f.serie %>-<%= f.numero %></td>
      <td><%= f.proveedor %></td>
      <td><%= f.producto %></td>
      <td><%= f.cantidad %></td>
      <td><%= f.precio_unitario %></td>
      <td><%= f.usuario %></td>
      <td><%= f.recepcion %></td>
      <td><%= f.estado %></td>
            
          </form>
        </tr>
      <% }) %>
    </tbody>
  </table>

<a href="/dashboard" class="btn btn-secondary mt-3">Volver al dashboard</a>

<script>
function agregarLinea() {
    const container = document.getElementById('lineas-producto');

    // Clonar la línea base
    const linea = container.firstElementChild.cloneNode(true);
    linea.querySelectorAll('input').forEach(input => input.value = '');
    linea.querySelector('select').selectedIndex = 0;

    // Asignar evento onchange para prevenir duplicados
    linea.querySelector('select').addEventListener('change', validarDuplicado);

    container.appendChild(linea);
  }

  function eliminarLinea(boton) {
    const linea = boton.closest('.row');
    const container = document.getElementById('lineas-producto');
    if (container.children.length > 1) {
      linea.remove();
    } else {
      alert('Debe haber al menos una línea de producto.');
    }
  }

  function validarDuplicado(e) {
  const selectActual = e.target;
  const valorSeleccionado = selectActual.value;
  const todosSelects = document.querySelectorAll('select[name="producto[]"]');

  for (const select of todosSelects) {
    if (select !== selectActual && select.value === valorSeleccionado) {
      alert('Este producto ya está seleccionado en otra línea.');
      selectActual.selectedIndex = 0; // Volver a la opción por defecto
      return;
    }
  }
}
  // Agregar validación al primer select ya existente
  document.addEventListener('DOMContentLoaded', () => {
    const primerSelect = document.querySelector('select[name="producto[]"]');
    primerSelect.addEventListener('change', validarDuplicado);
  });
</script>

</body>

</head>
