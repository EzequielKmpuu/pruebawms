<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>InfRecepcion</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/estilos.css">
</head>
<body class="p-4">

<h3>Informe de Recepción (<%= factura.recepcion %>) *-* Factura <%= factura.serie %>-<%= factura.numero %></h3>

<h5>Proveedor: <%= factura.proveedor %></h5>
<h6>Estado: <%= factura.estado %></h6>

<form id="formScan" onsubmit="return false;">
  <input id="codigoBarra" class="form-control w-25" placeholder="Escaneá el producto" required>
  <br>
</form>

<table class="table">
  <thead>
    <tr>
      <th>Producto</th>
      <th>Código</th>
      <th>Cantidad</th>
      <th>Recibidos</th>
      <th>Estado</th>
    </tr>
  </thead>
  <tbody id="tablaProductos">
    <% codigo.forEach(cc => { %>
      <tr data-codigo="<%= cc.codigo_barras %>">
        <td><%= cc.producto_nombre %></td>
        <td><%= cc.codigo_barras %></td>
        <td><%= cc.cantidad %></td>
        <td class="recibidos">0</td>
        <td class="estado">Pendiente</td>
      </tr>
    <% }) %>
  </tbody>
</table>

<button id="confirmarBtn" class="btn btn-success" disabled>Confirmar Recepción</button>

<script>

  const recepcion = "<%= factura.recepcion %>"; // o factura.id si usás ID
  const inputCodigo = document.getElementById('codigoBarra');
  const confirmarBtn = document.getElementById('confirmarBtn');

  inputCodigo.addEventListener('keydown', function (e) {
    if (e.key === 'Enter') {
      e.preventDefault();

      const codigo = this.value.trim().toLowerCase();
      if (!codigo) return alert('Ingrese un código válido');

      const fila = Array.from(document.querySelectorAll('tr[data-codigo]'))
        .find(tr => tr.getAttribute('data-codigo').toLowerCase() === codigo);

        if (!fila) {
        alert('Código no encontrado en esta factura');
        this.value = '';
        return;
      }

      let cantidadRecibida = prompt(`Ingrese cantidad recibida para ${fila.children[0].textContent}:`, '1');
      cantidadRecibida = parseInt(cantidadRecibida);
      if (isNaN(cantidadRecibida) || cantidadRecibida <= 0) {
        alert('Cantidad inválida');
        this.value = '';
        return;
      }

      const tdRecibidos = fila.querySelector('.recibidos');
      tdRecibidos.textContent = cantidadRecibida;

      const cantidadEsperada = parseInt(fila.children[2].textContent); // Columna Cantidad
      const tdEstado = fila.querySelector('.estado');

      if (cantidadRecibida > cantidadEsperada) {
      tdEstado.textContent = 'Sobrantes';

      if (tdEstado.textContent = 'Sobrantes') {
        alert('Se estan intentando ingresar mas unidades de las cantidades reales facturadas');
      }

       } else if (cantidadRecibida === cantidadEsperada) {
      tdEstado.textContent = 'Completado';
        } else {
      tdEstado.textContent = 'Pendiente';
        }

      confirmarBtn.disabled = false;
      this.value = '';
    }
  });

 confirmarBtn.addEventListener('click', () => {
  confirmarBtn.disabled = true;
  const filas = document.querySelectorAll('#tablaProductos tr');
  const productos = [];

  filas.forEach(fila => {
    const codigo = fila.getAttribute('data-codigo');
    const cantidad = parseInt(fila.querySelector('.recibidos').textContent);
    if (cantidad > 0) {
      productos.push({ codigo, cantidad });
    }
  });

  const recepcion = "<%= factura.recepcion %>"; // Esto tiene que estar en tu template  


  fetch('/recepciones/validar', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ productos, recepcion })
  })
    .then(res => res.json())
    .then(data => {
      alert('Stock y Facturas actualizados correctamente');
      window.location.href = '/recepciones';
    })
    .catch(err => {
      alert('Error al confirmar recepción');
      console.error(err);
    });
});

  // Para debug: ver todos los códigos en consola
  document.querySelectorAll('tr[data-codigo]').forEach(tr => {
  });
</script>


<a href="/recepciones" class="btn btn-secondary mt-3">Volver a Recepciones</a>
</body>
</head>
